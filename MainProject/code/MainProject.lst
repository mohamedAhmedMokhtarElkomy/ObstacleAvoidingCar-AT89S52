
ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 1





       MCS-51 Family Macro Assembler   A S E M - 5 1   V 1.3
       =====================================================



	Source File:	C:\Microcontroller project\microprocessor\MainProject\code\MainProject.asm
	Object File:	C:\Microcontroller project\microprocessor\MainProject\code\MainProject.hex
	List File:	C:\Microcontroller project\microprocessor\MainProject\code\MainProject.lst



 Line  I  Addr  Code            Source

    1:		N      0000	ORG 0000H; location where execution of the program starts from
    2:	  0000	02 00 30	LJMP START; LJMP used to bypass the ISR
    3:
    4:		N      0023	ORG 0023H; location for ISR for both TI and RI
    5:	  0023	02 01 37	LJMP SERIALINT
    6:
    7:				;R4 store received character
    8:				;R3 for storing value of TH from ultrasonic echo
    9:		N      0030	ORG 30H
   10:	  0030			START:
   11:	  0030	75 80 00	MOV P0, #0
   12:		B      0090	LeftForward EQU P1.0
   13:		B      0091	LeftBackward EQU P1.1
   14:		B      0092	RightForward EQU P1.2
   15:		B      0093	RightBackward EQU P1.3
   16:	  0033	C2 94		CLR P1.4
   17:
   18:		B      0097	AutoLED EQU P1.7	;LED indicate if Auto mode is on or not
   19:		B      0096	OnLED EQU P1.6
   20:		B      0095	DetectedPin EQU P1.5
   21:	  0035	C2 95		CLR DetectedPin
   22:	  0037	D2 96		SETB OnLED
   23:
   24:		B      00A0	TRIG EQU P2.0
   25:		B      00A1	ECHO EQU P2.1
   26:
   27:	  0039	C2 A0		CLR TRIG		; sets P2.0(TRIG) as output for sending trigger
   28:	  003B	D2 A1		SETB ECHO		; sets P2.1(ECHO) as input for receiving echo
   29:
   30:	  003D	C2 90		CLR LeftForward		; sets P1.0(LeftForward) as output
   31:	  003F	C2 91		CLR LeftBackward	; sets P1.1(LeftBackward) as output
   32:	  0041	C2 92		CLR RightForward	; sets P1.2(RightForward) as output
   33:	  0043	C2 93		CLR RightBackward	; sets P1.3(RightBackward) as output
   34:
   35:				;Setup serial port and timer 1 for bluetooth
   36:	  0045	75 89 21	MOV TMOD, #00100001B	;Mode 2 for timer 1 (8 bit auto reload)
   37:	  0048	75 8D FD	MOV TH1, #0FDH		;setting baud rate 9600
   38:	  004B	75 98 50	MOV SCON, #01010000B	;Serial Mode 1, REN Enabled
   39:	  004E	D2 8E		SETB TR1		;Run timer 1
   40:				;MOV IE, #10000000B	;enables interrupt
   41:
   42:	  0050			NormalMode:
   43:					;The following to instruction to reset when returning from AutoDriveMode

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 2



 Line  I  Addr  Code            Source

   44:	  0050	C2 97			CLR AutoLED
   45:	  0052	11 E4			ACALL StopCar
   46:	  0054	75 A8 80		MOV IE, #10000000B	;enables interrupt
   47:
   48:	  0057	30 98 FD	Main:	JNB RI, $	;Waiting for receive interrupt flag
   49:	  005A	E5 99			MOV A, SBUF	;Move received character to A
   50:	  005C	C2 98			CLR RI		;Clear receive interrupt flag
   51:	  005E	FC			MOV R4, A
   52:
   53:				;;;;;;;;Switch;;;;;;;;
   54:	  005F	C3			CLR C		;Clear carry flag befor using SUBB for comparing
   55:	  0060	94 66			SUBB A, #'f'	;Compare A to 'f'
   56:	  0062	60 1E			JZ Jmvfwd	;If A = 'f' MoveForward
   57:
   58:	  0064	EC			MOV A, R4;
   59:	  0065	C3			CLR C		;Clear carry flag befor using SUBB for comparing
   60:	  0066	94 62			SUBB A, #'b'	;Compare A to 'b'
   61:	  0068	60 1D			JZ Jmvbwd	;If A = 'b' MoveBackward
   62:
   63:	  006A	EC			MOV A, R4;
   64:	  006B	C3			CLR C		;Clear carry flag befor using SUBB for comparing
   65:	  006C	94 72			SUBB A, #'r'	;Compare A to 'r'
   66:	  006E	60 1C			JZ Jmvright	;If A = 'r' MoveRight
   67:
   68:	  0070	EC			MOV A, R4;
   69:	  0071	C3			CLR C		;Clear carry flag befor using SUBB for comparing
   70:	  0072	94 6C			SUBB A, #'l'	;Compare A to 'l'
   71:	  0074	60 1B			JZ Jmvleft	;If A = 'l' MoveLeft
   72:
   73:	  0076	EC			MOV A, R4;
   74:	  0077	C3			CLR C		;Clear carry flag befor using SUBB for comparing
   75:	  0078	94 61			SUBB A, #'a'	;Compare A to 'a'
   76:	  007A	60 21			JZ AutoDriveMode;If A = 'a' then active auto drive
   77:
   78:	  007C	EC			MOV A, R4;
   79:	  007D	C3			CLR C		;Clear carry flag befor using SUBB for comparing
   80:	  007E	94 73			SUBB A, #'s'	;Compare A to 's'
   81:	  0080	60 14			JZ Jstop	;If A = 's' stop the car
   82:
   83:
   84:				;;;;;;TRY TO OPTIMIZE;;;;;;
   85:	  0082	11 C0		Jmvfwd:	ACALL MoveForward
   86:	  0084	02 00 9B	JMP BckMain
   87:	  0087	11 C9		Jmvbwd:ACALL MoveBackward
   88:	  0089	02 00 9B	JMP BckMain
   89:	  008C	11 D2		Jmvright:ACALL MoveRight
   90:	  008E	02 00 9B	JMP BckMain
   91:	  0091	11 DB		Jmvleft:ACALL MoveLeft
   92:	  0093	02 00 9B	JMP BckMain
   93:	  0096	11 E4		Jstop:ACALL StopCar
   94:	  0098	02 00 9B	JMP BckMain
   95:
   96:	  009B	80 BA		BckMain:SJMP Main	;Jump back to Main for looping
   97:				;;;;;;TRY TO OPTIMIZE;;;;;;
   98:
   99:

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 3



 Line  I  Addr  Code            Source

  100:				;AutoDriveMode is mode for auto move and detect objects
  101:	  009D			AutoDriveMode:
  102:	  009D	75 A8 90		MOV IE, #10010000B	;enables serial interrupt which can be caused by both TI/RI
  103:	  00A0	D2 97			SETB AutoLED		;Turn on auto drive LED
  104:
  105:	  00A2			TrigAgain:
  106:	  00A2	C3			CLR C
  107:	  00A3	30 97 AA		JNB AutoLED, NormalMode	;IF autoLed pin is 0 JMP to NormalMode
  108:
  109:					;TODO remove or solve it
  110:	  00A6	C2 95			CLR DetectedPin
  111:
  112:	  00A8	D2 A0			SETB TRIG		; starts the trigger pulse
  113:	  00AA	31 0F			ACALL Delay10M     	; Delay 10uS width for the trigger pulse
  114:	  00AC	C2 A0			CLR TRIG         	; ends the trigger pulse
  115:
  116:	  00AE	30 A1 FD		JNB ECHO,$    		; loops here until echo is received
  117:
  118:	  00B1	11 FC			ACALL CalcDistance
  119:					;TODO when transistor be used
  120:	  00B3	20 8D 06		JB TF0, NoObj
  121:	  00B6	11 ED			ACALL Detected
  122:	  00B8	C2 8D			CLR TF0
  123:	  00BA	80 E6			SJMP TrigAgain
  124:
  125:	  00BC	11 C0		NoObj:	ACALL MoveForward
  126:	  00BE	80 E2			SJMP TrigAgain		;short jumps to again loop
  127:
  128:	  00C0			MoveForward:
  129:	  00C0	C2 93			CLR RightBackward
  130:	  00C2	C2 91			CLR LeftBackward
  131:	  00C4	D2 92			SETB RightForward
  132:	  00C6	D2 90			SETB LeftForward
  133:					;ACALL FeedBck
  134:	  00C8	22			RET
  135:
  136:	  00C9			MoveBackward:
  137:	  00C9	C2 92			CLR RightForward
  138:	  00CB	C2 90			CLR LeftForward
  139:	  00CD	D2 93			SETB RightBackward
  140:	  00CF	D2 91			SETB LeftBackward
  141:					;ACALL FeedBck
  142:	  00D1	22			RET
  143:
  144:	  00D2			MoveRight:
  145:	  00D2	C2 93			CLR RightBackward
  146:	  00D4	C2 91			CLR LeftBackward
  147:	  00D6	C2 92			CLR RightForward
  148:	  00D8	D2 90			SETB LeftForward
  149:					;ACALL FeedBck
  150:	  00DA	22			RET
  151:
  152:	  00DB			MoveLeft:
  153:	  00DB	D2 92			SETB RightForward
  154:	  00DD	C2 90			CLR LeftForward
  155:	  00DF	C2 93			CLR RightBackward

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 4



 Line  I  Addr  Code            Source

  156:	  00E1	C2 91			CLR LeftBackward
  157:					;ACALL FeedBck
  158:	  00E3	22			RET
  159:
  160:	  00E4			StopCar:
  161:	  00E4	C2 93			CLR RightBackward
  162:	  00E6	C2 91			CLR LeftBackward
  163:	  00E8	C2 92			CLR RightForward
  164:	  00EA	C2 90			CLR LeftForward
  165:					;ACALL FeedBck
  166:	  00EC	22			RET
  167:
  168:				;If object detected MoveBack for 1 sec then move right for 2 sec
  169:	  00ED			Detected:
  170:	  00ED	D2 95			SETB DetectedPin
  171:	  00EF	11 C9			ACALL MoveBackward
  172:	  00F1	31 1F			ACALL DelaySec
  173:	  00F3	11 D2			ACALL MOVERight
  174:	  00F5	31 1F			ACALL DelaySec
  175:	  00F7	31 1F			ACALL DelaySec
  176:	  00F9	C2 95			CLR DetectedPin
  177:	  00FB	22			RET
  178:
  179:
  180:	  00FC			CalcDistance:
  181:					;Loop until ECHO pin is low
  182:					;Start counting ticks from 44103D => AC47
  183:					;44103D for maximum distance
  184:	  00FC	75 8A 47		MOV TL0, #47H
  185:	  00FF	75 8C AC		MOV TH0, #0ACH
  186:
  187:	  0102	C2 8D			CLR TF0
  188:	  0104	D2 8C			SETB TR0	;start timer 0
  189:
  190:					;TODO LOOP while ECHO 1 and TF0 is 0
  191:	  0106	20 A1 FD		JB ECHO, $	;If ECHO is high loop to echo is 1
  192:
  193:					;TODO
  194:					;CheckECHO:JB ECHO, CheckOF
  195:					;	JMP d
  196:					;CheckOF: JNB TF0, CheckECHO
  197:							;IF else
  198:						;ACALL RestartUS
  199:	  0109	C2 8C			d:CLR TR0
  200:
  201:	  010B	22		RET
  202:
  203:				;TODO
  204:				;restart ultrasonic sensor
  205:	  010C			RestartUS:
  206:	  010C	C2 8C		CLR TR0
  207:	  010E	22		RET
  208:
  209:
  210:				;Delay 10 micro sec
  211:	  010F			Delay10M:

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 5



 Line  I  Addr  Code            Source

  212:					;MOV TMOD, #00000001B ;set timer0 as mode 1 16-bit
  213:	  010F	75 8A F7		MOV TL0, #0F7H
  214:	  0112	75 8C FF		MOV TH0, #0FFH
  215:
  216:	  0115	D2 8C			SETB TR0
  217:
  218:	  0117	30 8D FD		JNB TF0, $
  219:	  011A	C2 8C			CLR TR0
  220:	  011C	C2 8D			CLR TF0
  221:	  011E	22		RET
  222:
  223:	  011F			DelaySec:
  224:	  011F	C0 07			PUSH 07H
  225:	  0121	7F 14		    	MOV R7, #20D
  226:				    	;Timer Clk = 11.0592/12*1 = 0.9216 MHz
  227:					;50000 uS / (1 / 0.9216)uS = 46080 [65536 - 46080 = 19456 => 4C00H]
  228:	  0123				DelaySecLoop:
  229:	  0123	75 8A 00	    		MOV TL0, #00H
  230:	  0126	75 8C 4C	    		MOV TH0, #4CH
  231:	  0129	D2 8C		    		SETB TR0	;Start timer 0
  232:
  233:	  012B	30 8D FD	    		JNB TF0, $	;Loop until Timer 0 overflow = 1
  234:	  012E	C2 8C		    		CLR TR0		;Stop timer 0
  235:	  0130	C2 8D		    		CLR TF0		;Clear overFlow
  236:
  237:	  0132	DF EF		    		DJNZ R7, DelaySecLoop ;Decrement A then if A != 0 jump to DelaySecLoop
  238:
  239:	  0134	D0 07		    	POP 07H
  240:	  0136	22		RET
  241:
  242:
  243:	  0137			SERIALINT:
  244:	  0137	20 99 05		JB TI, TRANS; if the interrupt is caused by T1 control is transferred to trans as the old da
				ta has been transferred and new data can be sent to the SBUF
  245:	  013A	C2 97			CLR AutoLED
  246:	  013C	C2 98		        CLR RI; clears RI flag
  247:	  013E	32		        RETI; transfers control to main
  248:
  249:	  013F	32		TRANS:	RETI;  transfers control to main
  250:
  251:				END
  252:
  253:





                     register banks used:  ---

                     no errors




ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 6





	       L I S T   O F   S Y M B O L S
	       =============================


SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
??ASEM_51			  NUMBER    8051
??VERSION			  NUMBER    0130
AC				  BIT	      D6
ACC				  DATA	      E0
AUTODRIVEMODE			  CODE	    009D	 101
AUTOLED				  NUMBER    0097	  18
B				  DATA	      F0
BCKMAIN				  CODE	    009B	  96
CALCDISTANCE			  CODE	    00FC	 180
CY				  BIT	      D7
D				  CODE	    0109	 199
DELAY10M			  CODE	    010F	 211
DELAYSEC			  CODE	    011F	 223
DELAYSECLOOP			  CODE	    0123	 228
DETECTED			  CODE	    00ED	 169
DETECTEDPIN			  NUMBER    0095	  20
DPH				  DATA	      83
DPL				  DATA	      82
EA				  BIT	      AF
ECHO				  NUMBER    00A1	  25
ES				  BIT	      AC
ET0				  BIT	      A9
ET1				  BIT	      AB
EX0				  BIT	      A8
EX1				  BIT	      AA
EXTI0				  CODE	    0003
EXTI1				  CODE	    0013
F0				  BIT	      D5
IE				  DATA	      A8
IE0				  BIT	      89
IE1				  BIT	      8B
INT0				  BIT	      B2
INT1				  BIT	      B3
IP				  DATA	      B8
IT0				  BIT	      88
IT1				  BIT	      8A
JMVBWD				  CODE	    0087	  87
JMVFWD				  CODE	    0082	  85
JMVLEFT				  CODE	    0091	  91
JMVRIGHT			  CODE	    008C	  89
JSTOP				  CODE	    0096	  93
LEFTBACKWARD			  NUMBER    0091	  13
LEFTFORWARD			  NUMBER    0090	  12
MAIN				  CODE	    0057	  48
MOVEBACKWARD			  CODE	    00C9	 136
MOVEFORWARD			  CODE	    00C0	 128
MOVELEFT			  CODE	    00DB	 152
MOVERIGHT			  CODE	    00D2	 144
NOOBJ				  CODE	    00BC	 125
NORMALMODE			  CODE	    0050	  42

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 7



SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
ONLED				  NUMBER    0096	  19
OV				  BIT	      D2
P				  BIT	      D0
P0				  DATA	      80
P1				  DATA	      90
P2				  DATA	      A0
P3				  DATA	      B0
PCON				  DATA	      87
PS				  BIT	      BC
PSW				  DATA	      D0
PT0				  BIT	      B9
PT1				  BIT	      BB
PX0				  BIT	      B8
PX1				  BIT	      BA
RB8				  BIT	      9A
RD				  BIT	      B7
REN				  BIT	      9C
RESET				  CODE	    0000
RESTARTUS			  CODE	    010C	 205
RI				  BIT	      98
RIGHTBACKWARD			  NUMBER    0093	  15
RIGHTFORWARD			  NUMBER    0092	  14
RS0				  BIT	      D3
RS1				  BIT	      D4
RXD				  BIT	      B0
SBUF				  DATA	      99
SCON				  DATA	      98
SERIALINT			  CODE	    0137	 243
SINT				  CODE	    0023
SM0				  BIT	      9F
SM1				  BIT	      9E
SM2				  BIT	      9D
SP				  DATA	      81
START				  CODE	    0030	  10
STOPCAR				  CODE	    00E4	 160
T0				  BIT	      B4
T1				  BIT	      B5
TB8				  BIT	      9B
TCON				  DATA	      88
TF0				  BIT	      8D
TF1				  BIT	      8F
TH0				  DATA	      8C
TH1				  DATA	      8D
TI				  BIT	      99
TIMER0				  CODE	    000B
TIMER1				  CODE	    001B
TL0				  DATA	      8A
TL1				  DATA	      8B
TMOD				  DATA	      89
TR0				  BIT	      8C
TR1				  BIT	      8E
TRANS				  CODE	    013F	 249
TRIG				  NUMBER    00A0	  24
TRIGAGAIN			  CODE	    00A2	 105
TXD				  BIT	      B1
WR				  BIT	      B6
