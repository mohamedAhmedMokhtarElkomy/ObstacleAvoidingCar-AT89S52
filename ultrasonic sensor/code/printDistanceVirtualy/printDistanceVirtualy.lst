
ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 1





       MCS-51 Family Macro Assembler   A S E M - 5 1   V 1.3
       =====================================================



	Source File:	C:\Microcontroller project\microprocessor\ultrasonic sensor\code\printDistanceVirtualy\printDistanceVirtualy.asm
	Object File:	C:\Microcontroller project\microprocessor\ultrasonic sensor\code\printDistanceVirtualy\printDistanceVirtualy.hex
	List File:	C:\Microcontroller project\microprocessor\ultrasonic sensor\code\printDistanceVirtualy\printDistanceVirtualy.lst



 Line  I  Addr  Code            Source

    1:				;R5 is used in DLOOP for POPing from stack
    2:				;R6 is used in printing, storing ECHO times to be printed
    3:				;R7 is used in all Delays, as counter in DLOOP
    4:		N      0000	ORG 0
    5:	  0000	75 90 00	MOV P1,#00000000B      ; sets P1 as output port
    6:	  0003	75 80 00	MOV P0,#00000000B      ; sets P0 as output port
    7:
    8:		B      00A0	TRIG EQU P2.0
    9:	  0006	C2 A0		CLR TRIG               ; sets TRIG as output for sending trigger
   10:
   11:		B      00A1	ECHO EQU P2.1
   12:	  0008	D2 A1		SETB ECHO              ; sets ECHO as input for receiving echo
   13:
   14:	  000A	74 00		MOV A, #0H
   15:
   16:	  000C			MAIN:   ;TRIG CODE
   17:	  000C	D2 A0			SETB TRIG		; starts the trigger pulse
   18:	  000E	11 7B			ACALL Delay10M     	; Delay 10uS width for the trigger pulse
   19:	  0010	C2 A0			CLR TRIG         	; ends the trigger pulse
   20:	  0012	30 A1 FD		JNB ECHO,$    		; loops here until echo is received
   21:
   22:	  0015	11 4B			ACALL CalcDistance
   23:
   24:	  0017	11 64			ACALL DelaySec	 ;Delay 1 sec

   25:	  0019	80 F1			SJMP MAIN        ;short jumps to MAIN loop
   26:
   27:				;Display LOOP for send char to serial port for printing it on virtual terminal
   28:	  001B	75 89 20	DLOOP:	MOV TMOD, #20H	; or 00100000B => Mode 2 for Timer 1 (8bit Auto Reload)
   29:	  001E	75 8D FD		MOV TH1, #0FDH	;Setting BaudRate of 9600 (-3). SMOD is 0 by default
   30:	  0021	75 98 50		MOV SCON, #50H	;Serial Mode 1, REN Enabled or #01010000B
   31:	  0024	D2 8E			SETB TR1
   32:
   33:	  0026	EE			MOV A, R6
   34:	  0027	7F 00			MOV R7, #0D	;Counter to store count of numbers
   35:				;PrintDEC, print => for converting hex value to decimal then print each number
   36:	  0029				PrintDEC:
   37:	  0029	0F				INC R7
   38:	  002A	75 F0 0A			MOV B, #10D
   39:	  002D	84				DIV AB			;the quotient is stored in the accumulator and the remainder
				 is stored in the B register
   40:	  002E	C0 F0				PUSH B
   41:	  0030	B4 00 F6			CJNE A, #0D, PrintDEC	;Compare the first two operands and branches to the specifie

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 2



 Line  I  Addr  Code            Source

				d destination if their values are not equal
   42:
   43:	  0033	D0 05			print:	POP 05H			;POP to 05H which is R5
   44:	  0035	ED				MOV A, R5
   45:	  0036	24 30				ADD A, #'0'		;Add 0 hex value to print number from 0 to 9
   46:	  0038	F5 99				MOV SBUF, A
   47:	  003A	30 99 FD			JNB TI, $
   48:	  003D	C2 99				CLR TI
   49:						;ACALL DelaySec		;TODO i think it is not useful
   50:	  003F	DF F2				DJNZ R7, print		;decrements the byte indicated by the first operand and, if
				the resulting value is not zero, branches to the address specified in the second operand.
   51:	  0041	74 20				MOV A, #' '
   52:	  0043	F5 99				MOV SBUF, A
   53:	  0045	30 99 FD			JNB TI, $
   54:	  0048	C2 99				CLR TI
   55:
   56:	  004A	22		RET
   57:
   58:	  004B			CalcDistance:
   59:					;Loop until ECHO pin is low
   60:	  004B	75 89 01		MOV TMOD, #00000001B	;set timer0 as mode 1 16-bit
   61:					;Start counting ticks from 44103D => AC47
   62:	  004E	75 8A 47		MOV TL0, #47H
   63:	  0051	75 8C AC		MOV TH0, #0ACH
   64:
   65:	  0054	D2 8C			SETB TR0	;start timer 0
   66:
   67:					;TODO LOOP while ECHO 1 and TF0 is 0
   68:	  0056	20 A1 FD		JB ECHO, $	;If ECHO is high loop to echo is 1
   69:	  0059	C2 8C			CLR TR0
   70:
   71:					;Move TH0 to R6 to be printed
   72:	  005B	AE 8C			MOV R6, TH0
   73:	  005D	11 1B			ACALL DLOOP
   74:
   75:					;Move TL0 to R6 to be printed
   76:	  005F	AE 8A			MOV R6, TL0
   77:	  0061	11 1B			ACALL DLOOP
   78:	  0063	22		RET
   79:
   80:				;TODO store old value of R7
   81:	  0064			DelaySec:
   82:	  0064	75 89 01	    	MOV TMOD, #00000001B ;set timer0 as mode 1 16-bit
   83:	  0067	7F 14		    	MOV R7, #20D
   84:				    	;Timer Clk = 11.0592/12*1 = 0.9216 MHz
   85:					;50000 uS / (1 / 0.9216)uS = 46080 [65536 - 46080 = 19456 => 4C00H]
   86:	  0069				DelaySecLoop:
   87:	  0069	75 8A 00	    		MOV TL0, #00H
   88:	  006C	75 8C 4C	    		MOV TH0, #4CH
   89:	  006F	D2 8C		    		SETB TR0	;Start timer 0
   90:
   91:	  0071	30 8D FD	    		JNB TF0, $	;Loop until Timer 0 overflow = 1
   92:	  0074	C2 8C		    		CLR TR0		;Stop timer 0
   93:	  0076	C2 8D		    		CLR TF0		;Clear overFlow
   94:
   95:	  0078	DF EF		    		DJNZ R7, DelaySecLoop ;Decrement A then if A != 0 jump to DelaySecLoop

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 3



 Line  I  Addr  Code            Source

   96:
   97:				;    	POP 07H
   98:	  007A	22		RET
   99:
  100:				;Delay 10 micro sec
  101:	  007B			Delay10M:
  102:	  007B	75 89 01		MOV TMOD, #00000001B ;set timer0 as mode 1 16-bit
  103:	  007E	75 8A F7		MOV TL0, #0F7H
  104:	  0081	75 8C FF		MOV TH0, #0FFH
  105:
  106:	  0084	D2 8C			SETB TR0
  107:
  108:	  0086	30 8D FD		JNB TF0, $
  109:	  0089	C2 8C			CLR TR0
  110:	  008B	C2 8D			CLR TF0
  111:	  008D	22		RET
  112:
  113:				;Delay 1000 micro sec
  114:	  008E			Delay1000M:
  115:	  008E	75 89 01		MOV TMOD, #00000001B ;set timer0 as mode 2 16-bit
  116:	  0091	75 8A 66		MOV TL0, #66H
  117:	  0094	75 8C FC		MOV TH0, #0FCH
  118:
  119:	  0097	D2 8C			SETB TR0
  120:
  121:	  0099	30 8D FD		JNB TF0, $
  122:	  009C	C2 8C			CLR TR0
  123:	  009E	C2 8D			CLR TF0
  124:	  00A0	22		RET
  125:
  126:	  00A1			close:
  127:					END





                     register banks used:  ---

                     no errors




ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 4





	       L I S T   O F   S Y M B O L S
	       =============================


SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
??ASEM_51			  NUMBER    8051
??VERSION			  NUMBER    0130
AC				  BIT	      D6
ACC				  DATA	      E0
B				  DATA	      F0
CALCDISTANCE			  CODE	    004B	  58
CLOSE				  CODE	    00A1	 126
CY				  BIT	      D7
DELAY1000M			  CODE	    008E	 114
DELAY10M			  CODE	    007B	 101
DELAYSEC			  CODE	    0064	  81
DELAYSECLOOP			  CODE	    0069	  86
DLOOP				  CODE	    001B	  28
DPH				  DATA	      83
DPL				  DATA	      82
EA				  BIT	      AF
ECHO				  NUMBER    00A1	  11
ES				  BIT	      AC
ET0				  BIT	      A9
ET1				  BIT	      AB
EX0				  BIT	      A8
EX1				  BIT	      AA
EXTI0				  CODE	    0003
EXTI1				  CODE	    0013
F0				  BIT	      D5
IE				  DATA	      A8
IE0				  BIT	      89
IE1				  BIT	      8B
INT0				  BIT	      B2
INT1				  BIT	      B3
IP				  DATA	      B8
IT0				  BIT	      88
IT1				  BIT	      8A
MAIN				  CODE	    000C	  16
OV				  BIT	      D2
P				  BIT	      D0
P0				  DATA	      80
P1				  DATA	      90
P2				  DATA	      A0
P3				  DATA	      B0
PCON				  DATA	      87
PRINT				  CODE	    0033	  43
PRINTDEC			  CODE	    0029	  36
PS				  BIT	      BC
PSW				  DATA	      D0
PT0				  BIT	      B9
PT1				  BIT	      BB
PX0				  BIT	      B8
PX1				  BIT	      BA
RB8				  BIT	      9A

ASEM-51 V1.3                                         Copyright (c) 2002 by W.W. Heinz                                         PAGE 5



SYMBOL				  TYPE     VALUE	LINE
------------------------------------------------------------
RD				  BIT	      B7
REN				  BIT	      9C
RESET				  CODE	    0000
RI				  BIT	      98
RS0				  BIT	      D3
RS1				  BIT	      D4
RXD				  BIT	      B0
SBUF				  DATA	      99
SCON				  DATA	      98
SINT				  CODE	    0023
SM0				  BIT	      9F
SM1				  BIT	      9E
SM2				  BIT	      9D
SP				  DATA	      81
T0				  BIT	      B4
T1				  BIT	      B5
TB8				  BIT	      9B
TCON				  DATA	      88
TF0				  BIT	      8D
TF1				  BIT	      8F
TH0				  DATA	      8C
TH1				  DATA	      8D
TI				  BIT	      99
TIMER0				  CODE	    000B
TIMER1				  CODE	    001B
TL0				  DATA	      8A
TL1				  DATA	      8B
TMOD				  DATA	      89
TR0				  BIT	      8C
TR1				  BIT	      8E
TRIG				  NUMBER    00A0	   8
TXD				  BIT	      B1
WR				  BIT	      B6
